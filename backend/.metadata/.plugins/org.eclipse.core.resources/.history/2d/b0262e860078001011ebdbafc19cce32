package com.example.backend.controller;

import com.example.backend.model.User;
import com.example.backend.model.DashboardItem;
import com.example.backend.service.DataService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.UUID;

@CrossOrigin(origins = "http://localhost:5173") // Allow frontend to call backend
@RestController
@RequestMapping("/api")
public class ApiController {

    private final DataService dataService;

    public ApiController(DataService dataService) {
        this.dataService = dataService;
    }

    // ===== USERS =====
    @GetMapping("/users")
    public List<User> getUsers() throws IOException {
        return dataService.getUsersFromDb();
    }

    @PostMapping("/users")
    public ResponseEntity<User> createUser(@RequestBody User newUser) throws IOException {
        List<User> users = dataService.getUsersFromDb();
        newUser.setUserid(UUID.randomUUID().toString());
        newUser.setCreatedAt(new Date().toString());
        users.add(newUser);
        dataService.saveUsersToDb(users);
        return ResponseEntity.status(HttpStatus.CREATED).body(newUser);
    }

    // ===== DETAILS =====
    @GetMapping("/details")
    public List<DashboardItem> getDetails() throws IOException {
        return dataService.getDetailsFromDb();
    }

    @PostMapping("/details")
    public ResponseEntity<DashboardItem> addDetail(@RequestBody DashboardItem newItem) throws IOException {
        List<DashboardItem> details = dataService.getDetailsFromDb();
        newItem.setId(UUID.randomUUID().toString());
        newItem.setDate(new Date().toString());
        details.add(newItem);
        dataService.saveDetailsToDb(details);
        return ResponseEntity.status(HttpStatus.CREATED).body(newItem);
    }

    @PutMapping("/details/{id}")
    public ResponseEntity<DashboardItem> updateDetail(@PathVariable String id, @RequestBody DashboardItem updatedItem) throws IOException {
        List<DashboardItem> details = dataService.getDetailsFromDb();
        for (int i = 0; i < details.size(); i++) {
            if (details.get(i).getId().equals(id)) {
                updatedItem.setId(id);
                details.set(i, updatedItem);
                dataService.saveDetailsToDb(details);
                return ResponseEntity.ok(updatedItem);
            }
        }
        return ResponseEntity.notFound().build();
    }

    @DeleteMapping("/details/{id}")
    public ResponseEntity<Void> deleteDetail(@PathVariable String id) throws IOException {
        List<DashboardItem> details = dataService.getDetailsFromDb();
        boolean removed = details.removeIf(d -> d.getId().equals(id));
        if (removed) {
            dataService.saveDetailsToDb(details);
            return ResponseEntity.noContent().build();
        }
        return ResponseEntity.notFound().build();
    }
}
